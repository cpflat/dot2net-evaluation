# dot2netのチュートリアル

## 環境構築

この実験では、Dockerが利用できるLinux環境が必要です。sudoの権限が必須です。
まず最初に、Containerlabとdot2netをインストールしてください。

[Containerlab](https://containerlab.dev/)

[dot2net](https://github.com/cpflat/dot2net/)

[環境構築例 (Ubuntuの場合)](./setup.md)

## 必要なファイルについて

チュートリアルに必要なファイルは、GitHub上の[このディレクトリ](https://github.com/cpflat/dot2net-evaluation/tree/master/tutorial)にあります。

このディレクトリには、`ospf.dot`と`ospf.yaml`という2つのファイルがあります。
これら2つのファイルが、dot2netへの入力となります(ファイル名は自由に変えても構いません)。

DOTは、[Graphviz](https://graphviz.org/)で用いられるグラフ記述言語です。
もしGraphvizをインストールしていれば、以下のコマンドで`ospf.dot`に対応する可視化されたグラフを出力することができます。

    dot -Tpdf ospf.dot > ospf.pdf

この生成されたグラフを踏まえて`ospf.dot`の中身をみてみると、
2-4行目がグラフ中の3つのノードを、6-7行目がそれらの接続関係(リンク)を定義していることがわかります。
詳細なDOTの文法については、[Graphvizのドキュメント](https://graphviz.org/doc/info/lang.html)を参照してください。

また、各ノードに`class=router`という属性が記述されています。
この属性を持つノードは、オブジェクトクラス`router`に属していることを意味しています。
オブジェクトクラスは、`ospf.yaml`で定義されています。

`ospf.yaml`はDOTファイルを用いて設定ファイルを生成するためのルールが記述されたファイルです。
このファイルには、生成する設定ファイルの定義、IPアドレス割り当てのポリシー、オブジェクトクラスの定義(コンテナのimageや設定の部分テンプレート)などが含まれています。
生成されるファイルは各ノードごとに一式でノードに対応するディレクトリの中に生成され、利用時にはコンテナ上の指定されたパスにbindマウントされます。
`ospf.yaml`の場合、`daemons`と`vtysh.conf`の2つのファイルがそのまま各ノード用のディレクトリに配置され、`frr.conf`は設定テンプレートを用いてノードごとに対応するパラメータが埋め込まれる形で生成されます。
埋め込まれたパラメータは、`ospf.yaml`に書かれた各種ポリシーに従い自動的に割り当てられます。

`ospf.yaml`では、`nodeclass`と`interfaceclass`の2種類のオブジェクトクラスが定義されています。
これらは、DOTファイル上のノードとリンクにそれぞれ対応しています。
もしあるノードやリンクが何らかの定義されたクラスを属性として持たない場合(例: `ospf.dot`の各リンク)は、そのノードやリンクは(定義されていれば)`default`クラスに属するものと解釈されます(例: `ospf.dot`の各ノードのインタフェースは、`default`クラスに属しています)。

より詳しい使い方や記法については、dot2netの[readme.md](https://github.com/cpflat/dot2net/)を参照してください。


## dot2netとContainerlabの使い方

まずはやってみるのがわかりやすいと思います。
dot2netを用いて、Containerlab向けの設定ファイル一式を生成してみましょう。

    dot2net clab -c ./ospf.yaml ./ospf.dot > topo.yaml

(もしdot2netの実行パスが登録されていない場合、コマンド名の`dot2net`の部分をインストールしたdot2net実行ファイルの絶対パスで置き換えてください。)

このコマンドにより、ノード名に対応する3つのディレクトリと、ContainerlabのTopologyファイルである`topo.yaml`というYAMLファイルが生成されます。
3つのディレクトリは、それぞれ`ospf.yaml`で定義された3つのファイルを内包しています。

ContainerlabのTopologyファイルは、ノード(コンテナimageやファイルのbindマウント設定など)やリンクの設定を示しています。
このTopologyファイルの記法については、[Containerlabのドキュメント](https://containerlab.dev/manual/topo-def-file/)を参照してください。

次に以下のコマンドで、Containerlabを用いてDockerのネットワークを展開してみましょう。

    sudo containerlab deploy --topo topo.yaml

展開に成功したコンテナは、`docker ps`コマンドで確認することができます。
各コンテナのログインシェルにアタッチするには、例えば`docker exec -it clab-tutorial-r1 /bin/sh`のようなコマンドを使ってください。
また、ノード`r1`とノード`r3`が互いに通信可能であることを、pingコマンドなどを用いて確認してください。

展開したネットワークについてのテストが終わったら、以下のコマンドで展開したネットワークを削除することが可能です。

    sudo containerlab destroy --topo topo.yaml


## Containerlabを用いてネットワークトポロジを変更する

従来の方法では、ネットワークトポロジを変更するにはContainerlabのTopologyファイルや各ノードの設定ファイルをそれぞれ変更する必要があります。
ここでは、ノード`r4`とそれについてのリンク`r3:net1-r4:net0`を追加してみましょう。
`topo.yaml`を修正し、また新しく`r4`ディレクトリを生成してそこに設定ファイルを配置する必要があります。
`r4/frr.conf`の作成にあたっては、IPアドレスの割り当てについても考慮してパラメータを記述する必要があります。
加えて、r4の隣のノードとなるr3について、`r3/frr.conf`のneighborの設定を追加することも必要です。

変更が完了したら、拡張したTopologyをContainerlabで展開して、r1とr4が通信可能か動作確認してみましょう。
もしうまくいかなければ、頑張って原因を調べて正しい設定へと修正してみてください
(修正する場合、ネットワークは一度destroyしてからもう一度deployし直してください)。


## dot2netを用いてネットワークトポロジを変更する

Containerlabを用いた設定変更はうまくいきましたか？
努力の証として、設定一式はどこかにコピーして残しておきましょう。

dot2netを使えば、もっと簡単にトポロジを変更することが可能です。
`ospf.dot`に設定を2行追加してみましょう。
一つは、`class=router`属性を持つノード`r4`を追加する設定です。
もう一つは、リンク`r3->r4`を追加する設定です(`r4->r3`でも構いません)。
この時、`ospf.yaml`については何も修正が必要ないことに注意してください。

この変更を踏まえ、もう一度dot2netを用いて`topo.yaml`を生成してみましょう。
生成されたファイルをみると、追加されたノードについても同じく自動計算されたパラメータが埋め込まれています。

この生成されたTopology fileを用いて、Containerlabで拡張されたトポロジのネットワークを展開してみましょう。
もしうまくいかなければ、同じようにトラブルシューティングしてみてください。


## 実験でやること

4つの指示されたネットワーク構成の変更の課題について、グループごとに指定された方法(Containerlabもしくはdot2net)で取り組んでいただきます。
グループごとにディレクトリが分かれているので、対応するグループについての指示に従ってください。

データ提供に同意いただける方は、各課題の実施中に要した時間と、Containerlabによる展開の試行回数(失敗がなければ1)をそれぞれ記録してください。
このデータは、設定変更の用意さの観点で従来手法(Containerlab)とdot2netの比較を行うために利用します。

もし1課題あたり1時間以上かかってしまう場合は、その課題については打ち切っても構いません。
その場合は、その課題について"1時間以上"と報告してください。

